name: Feature Branch Deployment

on:
  pull_request:
    # branches: [dev, staging, prod, main]  # filter according to the PR target branch
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: [self-hosted, cicd]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          IMAGE_TAG="aula-frontend:pr-${{ github.event.number }}"
          docker build -t $IMAGE_TAG .

      - name: Push Docker image
        run: docker push $IMAGE_TAG
  deploy:
    # skip deploying dev,staging,prod branches when they're the PR source branch
    if: ${{ !contains(fromJSON('["dev", "staging", "prod"]'), github.head_ref) }}
    runs-on: [self-hosted, branch]
    needs: build
    env:
      PR_NUMBER: ${{ github.event.number }} # PR Number
      PORT: ${{ github.event.number }} + 30000 # Example: Assigning a port based on PR number
    steps:
      - name: Deploy to Testing Environment
        run: |
          IMAGE_TAG="aula-frontend:pr-$PR_NUMBER"
          # Use docker-compose to run the service on a specific port
          docker-compose -f ./docker-compose.pr.yml up -d --build
