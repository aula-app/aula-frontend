name: Feature Branch Deployment

on:
  pull_request:
    # branches: [dev, staging, prod, main]  # filter according to the PR target branch
    types: [opened, synchronize, reopened]

env:
  IMAGE_TAG: 'aulaapp/aula-frontend:pr-${{ github.event.number }}'

jobs:
  build:
    runs-on: [self-hosted, cicd]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

      - name: Push Docker image
        run: docker push $IMAGE_TAG
  deploy:
    # skip deploying dev,staging,prod branches when they're the PR source branch
    if: ${{ !contains(fromJSON('["main", "dev", "staging", "prod"]'), github.head_ref) }}
    runs-on: [self-hosted, branch]
    needs: build
    env:
      PR_NUMBER: ${{ github.event.number }} # PR Number
      PORT: '3${{ github.event.number }}' # Example: Assigning a port based on PR number
    steps:
      - name: Deploy to Branch Testing Environment
        run: docker compose -f ./docker-compose.pr.yml up -d --build
