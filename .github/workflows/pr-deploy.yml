name: Feature Branch Deployment

on:
  pull_request:
    # branches: [dev, staging, prod, main]  # filter according to the PR target branch
    types: [opened, synchronize, reopened]

env:
  IMAGE_TAG: 'aulaapp/aula-frontend:pr-${{ github.event.number }}'
  PR_NUMBER: ${{ github.event.number }}
  PORT: '3${{ github.event.number }}' # assign a port based on PR number 3xxx

jobs:
  build:
    runs-on: [self-hosted, cicd]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

      - name: Push Docker image
        run: docker push $IMAGE_TAG
  deploy-dev:
    if: ${{ !contains(fromJSON('["main", "dev", "staging", "prod"]'), github.head_ref) }}
    runs-on: [self-hosted, dev]
    needs: build
    steps:
      - name: Deploy to Branch Testing Environment
        run: docker compose -f ./docker-compose.pr.yml up -d --build
  deploy-staging:
    if: ${{ !contains(fromJSON('["main", "dev", "staging", "prod"]'), github.head_ref) }}
    runs-on: [self-hosted, staging]
    needs: deploy-dev
    steps:
      - name: Deploy to Branch Testing Environment
        run: docker compose -f ./docker-compose.pr.yml up -d --build
